import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# ========== –¢–í–û–ò –î–ê–ù–ù–´–ï ==========
TG_TOKEN = "8586330885:AAEMIVWmzPU4l4XQ-gA8MdFe33TCPUmuLwQ"
OPENROUTER_KEY = "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"
# =================================

# ========== –ü–†–û–í–ï–†–ö–ê –¢–ï–ú–´ ==========
def is_admission_question(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é"""
    text_lower = text.lower()
    
    keywords = [
        '–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ', '–ø–æ—Å—Ç—É–ø–∏—Ç—å', '–∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç', '–ø—Ä–∏–µ–º–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è',
        '–≤—É–∑', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '–∏–Ω—Å—Ç–∏—Ç—É—Ç', '–∞–∫–∞–¥–µ–º–∏—è', '–∫–æ–ª–ª–µ–¥–∂',
        '–µ–≥—ç', '—ç–∫–∑–∞–º–µ–Ω', '–±–∞–ª–ª', '–ø—Ä–æ—Ö–æ–¥–Ω–æ–π', '–±—é–¥–∂–µ—Ç', '–ø–ª–∞—Ç–Ω–æ–µ',
        '–æ–±—â–µ–∂–∏—Ç–∏–µ', '–¥–æ–∫—É–º–µ–Ω—Ç—ã', '–ø–æ–¥–∞—Ç—å', '–∑–∞—è–≤–ª–µ–Ω–∏–µ', '—Ñ–∞–∫—É–ª—å—Ç–µ—Ç',
        '–∫–∞—Ñ–µ–¥—Ä–∞', '—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å', '–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞',
        '–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç', '–æ–ª–∏–º–ø–∏–∞–¥–∞', '–ª—å–≥–æ—Ç–∞', '—Ü–µ–ª–µ–≤–æ–µ',
        '–º–≥—É', '–≤—à—ç', '—Å–ø–±–≥—É', '–∏—Ç–º–æ', '–º—Ñ—Ç–∏', '–º–∏—Ñ–∏', '—Ä–∞–Ω—Ö–∏–≥—Å',
        '—Ä–≥—É—Ñ–∫', '–≥—Ü–æ–ª–∏—Ñ–∫', '—Ä–≥—É—Ñ–∫—Å–º–∏—Ç',
    ]
    
    for word in keywords:
        if word in text_lower:
            return True
    return False
# ====================================

# ========== –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –¢–ò–ü–ê –í–û–ü–†–û–°–ê ==========
def detect_question_type(text: str):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤—É–∑"""
    text_lower = text.lower()
    
    universities = ['–º–≥—É', '–≤—à—ç', '—Å–ø–±–≥—É', '–∏—Ç–º–æ', '–º—Ñ—Ç–∏', '–º–∏—Ñ–∏', '—Ä–∞–Ω—Ö–∏–≥—Å', 
                    '—Ä–≥—É—Ñ–∫', '–≥—Ü–æ–ª–∏—Ñ–∫', '–º–≥—Ç—É', '—Ç–ø—É', '—É—Ä—Ñ—É', '–∫—Ñ—É', '–¥–≤—Ñ—É']
    
    for uni in universities:
        if uni in text_lower:
            return 'university', uni
    
    return 'general', None
# ================================================

def ask_ai(question: str, question_type: str, university=None) -> str:
    """–ó–∞–ø—Ä–æ—Å –∫ OpenRouter —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
    
    if question_type == 'general':
        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –≤—É–∑—ã –†–æ—Å—Å–∏–∏.
        
–û—Ç–≤–µ—á–∞–π –Ω–∞ –û–ë–©–ò–ï –≤–æ–ø—Ä–æ—Å—ã –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤:

‚úÖ –ß–¢–û –¢–´ –ó–ù–ê–ï–®–¨ –û–¢–õ–ò–ß–ù–û:
- –ö–∞–∫–∏–µ —ç–∫–∑–∞–º–µ–Ω—ã –ï–ì–≠ –Ω—É–∂–Ω—ã –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
- –°–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å–¥–∞–≤–∞—Ç—å, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã
- –ö—É–¥–∞ –ø–æ—Å—Ç—É–ø–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
- –ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –±—é–¥–∂–µ—Ç –æ—Ç –ø–ª–∞—Ç–Ω–æ–≥–æ
- –ß—Ç–æ —Ç–∞–∫–æ–µ —Ü–µ–ª–µ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ, –æ–ª–∏–º–ø–∏–∞–¥—ã, –ª—å–≥–æ—Ç—ã
- –°—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –ø–µ—Ä–µ—á–µ–Ω—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–∂–∏—Ç–∏–µ, —Å—Ç–∏–ø–µ–Ω–¥–∏–∏

‚ùå –ï–°–õ–ò –°–ü–†–ê–®–ò–í–ê–Æ–¢ –ü–†–û –ö–û–ù–ö–†–ï–¢–ù–´–ô –í–£–ó:
–ù–∞–ø—Ä–∞–≤–ª—è–π –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ü–∏—Ñ—Ä—ã

üìå –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –ö—Ä–∞—Ç–∫–æ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
2. –ü–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã
3. –° —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
4. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏"""
    
    else:
        system_prompt = f"""–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –≤—É–∑: {university}

‚ö†Ô∏è –í–ê–ñ–ù–û:
1. –ï—Å–ª–∏ —Ç—ã –ù–ï –ó–ù–ê–ï–®–¨ —Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —ç—Ç–æ–º—É –≤—É–∑—É ‚Äî —Å—Ä–∞–∑—É —Å–∫–∞–∂–∏:
   "–Ø –Ω–µ –∑–Ω–∞—é —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ {university}. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ –ø—Ä–∏—ë–º–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é."
2. –ù–ï –í–´–î–£–ú–´–í–ê–ô –ø—Ä–æ—Ö–æ–¥–Ω—ã–µ –±–∞–ª–ª—ã, –∫–∞—Ñ–µ–¥—Ä—ã, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã
3. –¢–æ–ª—å–∫–æ –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–µ–±–µ –∏–∑–≤–µ—Å—Ç–Ω–∞"""

    try:
        response = requests.post(
            url="https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": "deepseek/deepseek-r1-0528:free",
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": question}
                ]
            },
            timeout=30
        )
        result = response.json()
        return result["choices"][0]["message"]["content"]
    except Exception as e:
        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    question = update.message.text
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–º—É
    if not is_admission_question(question):
        await update.message.reply_text(
            "‚ùå *–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –æ—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ –≤—É–∑—ã.*\n\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ /help —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –æ —á—ë–º –º–µ–Ω—è –º–æ–∂–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å.",
            parse_mode="Markdown"
        )
        return
    
    # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞
    question_type, university = detect_question_type(question)
    
    # 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç –¥—É–º–∞–µ—Ç
    await update.message.reply_chat_action("typing")
    
    if question_type == 'general':
        thinking = await update.message.reply_text("üìö –ò—â—É –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...")
    else:
        thinking = await update.message.reply_text(f"üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ {university.upper()}...")
    
    # 4. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
    answer = ask_ai(question, question_type, university)
    
    # 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    await thinking.delete()
    await update.message.reply_text(answer)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    text = """
üéì *–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –≤—É–∑—ã.*

–Ø –æ—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ:
üìö –ï–ì–≠ –∏ —ç–∫–∑–∞–º–µ–Ω—ã
üè´ –í—É–∑—ã, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã, –∫–∞—Ñ–µ–¥—Ä—ã
üí∞ –ë—é–¥–∂–µ—Ç, –ø–ª–∞—Ç–Ω–æ–µ, —Ü–µ–ª–µ–≤–æ–µ
üè† –û–±—â–µ–∂–∏—Ç–∏–µ –∏ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ
üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Å—Ä–æ–∫–∏

_–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:_
‚Ä¢ –ö–∞–∫–∏–µ —ç–∫–∑–∞–º–µ–Ω—ã —Å–¥–∞–≤–∞—Ç—å –Ω–∞ ...?
‚Ä¢ –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª –≤ ...?
‚Ä¢ –ï—Å—Ç—å –ª–∏ –æ–±—â–µ–∂–∏—Ç–∏–µ –≤ ...?
‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ —Ü–µ–ª–µ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ?

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å üëá
"""
    await update.message.reply_text(text, parse_mode="Markdown")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    text = """
üìå *–ö–∞–∫ –º–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:*

1Ô∏è‚É£ –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏
2Ô∏è‚É£ –Ø –Ω–∞–π–¥—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
3Ô∏è‚É£ –ü–æ–ª—É—á–∏—à—å –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –∏ —Å–æ–≤–µ—Ç

‚ùå *–Ø –Ω–µ –æ—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º* 

–ï—Å–ª–∏ —è –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–∫–∞–∂—É —á–µ—Å—Ç–Ω–æ –∏ –ø–æ–¥—Å–∫–∞–∂—É, –≥–¥–µ –∏—Å–∫–∞—Ç—å ‚úÖ
"""
    await update.message.reply_text(text, parse_mode="Markdown")

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å OpenRouter...")
    
    app = Application.builder().token(TG_TOKEN).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤! –ñ–¥—É –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏...")
    app.run_polling()

if __name__ == "__main__":
    main()